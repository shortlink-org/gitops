stage:
  - deploy

prometheus-operator:crd:
  stage: deploy

  # Parent job forks once for each CRD row â†“
  parallel:
    matrix:
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagerconfigs.yaml
        CRD_APPLYSET: alertmanagerconfigs
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagers.yaml
        CRD_APPLYSET: alertmanagers
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_podmonitors.yaml
        CRD_APPLYSET: podmonitors
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_probes.yaml
        CRD_APPLYSET: probes
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_prometheusagents.yaml
        CRD_APPLYSET: prometheusagents
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_prometheuses.yaml
        CRD_APPLYSET: prometheuses
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_prometheusrules.yaml
        CRD_APPLYSET: prometheusrules
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_scrapeconfigs.yaml
        CRD_APPLYSET: scrapeconfigs
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_servicemonitors.yaml
        CRD_APPLYSET: servicemonitors
      - CRD_URL: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.83.0/example/prometheus-operator-crd/monitoring.coreos.com_thanosrulers.yaml
        CRD_APPLYSET: thanosrulers

  trigger:
    include:
      - component: $CI_SERVER_FQDN/shortlink-org/gitlab-templates/crd@main
        inputs:
          kube_context: shortlink-org/argocd:${PROVIDER}
          applyset:     $CRD_APPLYSET
          manifest:     $CRD_URL
    strategy: depend     # parent waits for all child pipelines